---
title: "hochrechnung"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{hochrechnung}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<!-- ```{r, include = FALSE} -->
<!-- knitr::opts_chunk$set( -->
<!--   collapse = TRUE, -->
<!--   comment = "#>" -->
<!-- ) -->
<!-- ``` -->

<!-- ```{r setup} -->
<!-- library(plausi) -->

<!-- # Installiere das "swissdd"-Package um die Abstimmungsdaten von opendata.swiss zu beziehen -->
<!-- # devtools::install_github("politanch/swissdd") -->

<!-- library(plausi) -->
<!-- library(tidyverse) -->
<!-- library(swissdd) -->
<!-- library(caret) -->

<!-- # BFS Nummern ausgewählter Gemeinden -->
<!-- bfs_nrs <- c(6,7,10,11,12,87,219,294,181,38,60,92,119,182,218) -->

<!-- # Sys.setenv(https_proxy="") -->

<!-- # Beziehe historische Daten -->
<!-- results <- swissdd::get_nationalvotes(from_date="2017-03-01", to_date="2020-09-27") -->

<!-- # Formattiere historische Daten um ins Wide-Format (=eine Spalte je Vorlage) -->
<!-- testdata <- results %>% -->
<!--   filter(canton_id==1) %>%  -->
<!--   mutate(id=paste0("v",id)) %>% -->
<!--   select(jaStimmenInProzent, id, mun_id, mun_name) %>% -->
<!--   pivot_wider(names_from=id, values_from = jaStimmenInProzent) %>%  -->
<!--   drop_na() -->



<!-- # Gewisse Gemeinden sind etwas schwerer hervorzussagen - wenn sie 'extreme sind'.  -->
<!-- # Upsampling für höheres Gewicht!  -->

<!-- traindata <- testdata %>% -->
<!--         mutate(ntimes = ifelse(mun_id %in% c(261, 12), 3, 1))  -->

<!-- traindata <- as_tibble(lapply(traindata, rep, traindata$ntimes)) %>% -->
<!--         select(-ntimes) -->

<!-- # Sage Resultate vorher -->
<!-- predicted_results <- predict_votes(c("v6330","v6310"), -->
<!--                                    train=traindata,  -->
<!--                                    test=testdata, -->
<!--                                    method = "svmRadial", -->
<!--                                    exclude_votes = TRUE,  -->
<!--                                    geovars=c("mun_id","mun_name" )) -->


<!-- # Trainingsdatensatz erstellen (nur ausgezählte Gemeinden) -->
<!-- train <- testdata %>%  -->
<!--   mutate_at(vars(v6310,v6330), -->
<!--             ~ifelse(mun_id %in% bfs_nrs,NA, .)) -->

<!-- # Sage Resultate vorher -->
<!-- predicted_results <- predict_votes(c("v6330","v6310"), -->
<!--                                    train=train,  -->
<!--                                    test=testdata , -->
<!--                                    method = "svmRadial", -->
<!--                                    exclude_votes = TRUE,  -->
<!--                                    geovars=c("mun_id","mun_name" )) -->

<!-- # Mittlerer Vorhersagefehler (RMSE) pro Vorlage -->
<!-- predicted_results %>%  -->
<!--   group_by(vorlage) %>%  -->
<!--   summarize(rmse=RMSE(pred,real)) -->

<!-- # Auffällige Ja-Anteile weichen über drei mittleren Vorhersagefehlern von der Vorhersage ab -->
<!-- gem_pred <- predicted_results%>%  -->
<!--   mutate(error=real-pred) %>%  -->
<!--   group_by(vorlage) %>%  -->
<!--   mutate(rmse=RMSE(pred,real)) %>%  -->
<!--   mutate(error_rmse=error/rmse) %>%  -->
<!--   mutate(outlier=error_rmse>3) -->

<!-- ``` -->


<!-- # Streuung der Vorhersagefehler je Vorlage in der Vergangenheit -->

<!-- ```{r predictions} -->

<!-- # predict_single_vote("v6310", traindata=testdata, testprop = 0.1,geovars=c("mun_id","mun_name")) -->

<!-- predictions <- predict_votes(colnames(testdata)[c(-1,-2)][1:20],  -->
<!--                              train=testdata,  -->
<!--                              testprop = 0.3, -->
<!--                              method = "svmRadial", -->
<!--                              geovars=c("mun_id","mun_name")) -->


<!-- gem_pred <- predictions %>%  -->
<!--   mutate(error=real-pred) %>%  -->
<!--   group_by(vorlage) %>%  -->
<!--   mutate(rmse=RMSE(pred,real)) %>%  -->
<!--   mutate(error_rmse=error/rmse) %>%  -->
<!--   mutate(outlier=error_rmse>3) -->


<!-- ggplot(gem_pred, aes(vorlage, error))+ -->
<!--   geom_jitter(aes(color=outlier))+ -->
<!--   geom_violin(alpha=0.5)+ -->
<!--   scale_color_viridis_d()+ -->
<!--   theme_minimal() -->

<!-- ``` -->


<!-- # Streuung der Vorhersagefehler je Vorlage in der Vergangenheit -->

<!-- ```{r predictions} -->

<!-- # predict_single_vote("v6310", traindata=testdata, testprop = 0.1,geovars=c("mun_id","mun_name")) -->

<!-- predictions <- predict_votes(colnames(testdata)[c(-1,-2)][1:20],  -->
<!--                              train=testdata,  -->
<!--                              testprop = 0.3, -->
<!--                              geovars=c("mun_id","mun_name")) -->


<!-- gem_pred <- predictions %>%  -->
<!--   mutate(error=real-pred) %>%  -->
<!--   group_by(vorlage) %>%  -->
<!--   mutate(rmse=RMSE(pred,real)) %>%  -->
<!--   mutate(error_rmse=error/rmse) %>%  -->
<!--    mutate(outlier=error_rmse>3) -->


<!-- ggplot(gem_pred, aes(vorlage, error))+ -->
<!--   geom_jitter(aes(color=outlier))+ -->
<!--   geom_violin(alpha=0.5)+ -->
<!--   scale_color_viridis_d()+ -->
<!--   theme_minimal() -->

<!-- ``` -->





