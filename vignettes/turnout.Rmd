---
title: "Detect Anomalous Voter Turnout Rates"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Detect Anomalous Voter Turnout Rates}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

To detect anomalies in voter turnout, the `plausi`-package offers functions that allow for systematic comparison of turnout differences across various proposals for all precincts.

Generally, there are relatively clear ranking in turnout levels. Certain proposals mobilize more than others. Factors such as the topic of the proposal, the intensity of the campaign, and the level at which the issue is addressed all play a significant role. Cantonal proposals typically show lower turnout across the board compared to national proposals on the same voting day. We can leverage this for validation purposes. The following example uses open voting data available on opendata.swiss for illustration.

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE, 
  message = FALSE) 
```

```{r setup, message=FALSE}

# Installiere das "swissdd"-Package um die Abstimmungsdaten von opendata.swiss zu beziehen
devtools::install_github("politanch/swissdd")

# Load libraries
library(plausi)
library(swissdd)
library(tidyverse)

```

# Data Retrieval

For reproducibility, this example uses openly available data. With the `swissdd` package, data can be retrieved for a selected vote date.

```{r ,message=FALSE, warning=FALSE}

#  Retrieve results from September 27, 2020
data <- swissdd::get_nationalvotes(votedates = c("2020-09-27"))

# # Get all possible combinations of proposals
combinations <-as.data.frame(t(combn(unique(data$id),2)))

# Reduce the dataset to turnout and , vote id and geographic attributes
data_wide <- data %>% 
  select(id, canton_name,mun_name, mun_id, stimmbeteiligungInProzent) %>% 
  # Transpose into wide format
  pivot_wider(names_from=id,values_from=stimmbeteiligungInProzent) %>% 
  mutate_if(is.character,as.factor) %>% 
  # Filter data for the canton of Zurich
  filter(canton_name=="Zürich")

# Differenzen im Wide-Format
# cross_fun(data_wide, combinations$V1[2],combinations$V2[2],geo_cols=c("canton_name","mun_name","mun_id"))

# Berechne Stimmbeteiligungsdifferenzen
diff <- get_differences(data_wide,combinations$V1,combinations$V2,geo_cols=c("canton_name","mun_name","mun_id")) 
```

# Identify Suspicious Voter Turnout Differences

Now that we have calculated the voter turnout differences between the various proposals for each municipality, the next step is to identify which municipalities show statistically suspicious differences for each proposal combination. For this, we use the `is_outlier_double_mad` function from the plausi package.

```{r ,message=FALSE, warning=FALSE}
diff2 <- diff %>% 
  group_by(combination) %>% 
  # Threshold für Ausreisser : Abweichung von mehr als 5 medianen Abweichungen vom Median anstatt der üblichen 3.5.
  mutate(outlier=is_outlier_double_mad(difference,thres=5))
```

A plot helps to visualize the distribution of differences and to identify particularly  values.

```{r}
ggplot(diff2, aes(combination, difference))+
  geom_violin()+
  geom_jitter(alpha=0.3, aes(color=outlier))+
  theme_minimal()+
  scale_fill_viridis_d()

```

In some combinations, there are differences of up to 3 percentage points in certain cases.

```{r}
diff2 %>% 
  arrange(desc(abs(difference))) %>% 
  head()
```

# Identify the Responsible Proposal
To determine which proposals cause combinations to stand out:

Extract proposal IDs from combinations
Format data to count how often a proposal appears in notable combinations
Sort by frequency

```{r , message=FALSE, waning=FALSE}

problem_vorlagen <- diff2 %>% 
  separate(combination,into=c("vorlage1","vorlage2"), sep="_") %>% 
  filter(outlier==TRUE) %>% 
  pivot_longer( cols = -c(canton_name,mun_name,mun_id, difference, outlier), names_to="vorlage", values_to="vorlage_id") %>% 
  group_by(mun_name,mun_id,vorlage_id) %>% 
  summarize(n=n()) %>% 
  arrange(desc(n))

problem_vorlagen
  
```

