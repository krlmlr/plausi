---
title: "turnout"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{turnout}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


To detect anomalies in voter turnout, the `plausi`-package offers functions that allow for systematic comparison of turnout differences across various proposals for all precincts.

Generally, there usually is a relatively clear ranking in turnout levels. Certain proposals mobilize more than others. Factors such as the topic of the proposal, the intensity of the campaign, and the level at which the issue is addressed all play a significant role. Cantonal proposals typically show lower turnout across the board compared to national proposals on the same voting day. We can leverage this for validation purposes. The following example uses open voting data available on opendata.swiss for illustration.

```{r, include = FALSE}

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE, 
  message = FALSE)

```

```{r setup, message=FALSE}

# Load libraries
library(plausi)
library(ggplot2)

```

## Data Retrieval

For reproducibility, this example uses openly available data. With the `swissdd` package, data can be retrieved for a selected vote date.

```{r ,message=FALSE, warning=FALSE}

#  Retrieve result data from the canton of Zurich for September 27, 2020
data <- as.data.frame(result_data[result_data$votedate == "2020-09-27", ])

# Get all possible combinations of proposals
combinations <- as.data.frame(t(combn(unique(data$id), 2)))

# Reduce the dataset to turnout, vote id and geographic attributes
data_wide <- data |> 
  subset(select = c(id, mun_id, mun_name, stimmbeteiligungInProzent)) |> 
  stats::reshape(
    timevar = "id", 
    idvar = c("mun_id", "mun_name"), 
    direction = "wide"
  )

# Rename
names(data_wide) <- gsub("stimmbeteiligungInProzent.", "", names(data_wide))

# Calculate turnout differences
diff1 <- get_differences(data_wide, combinations$V1, combinations$V2, geo_cols = c("mun_name", "mun_id"))

```

## Identify Suspicious Voter Turnout Differences

Now that we have calculated the voter turnout differences between the various proposals for each municipality, the next step is to identify which municipalities show statistically suspicious differences for each proposal combination. For this, we use the `is_outlier_double_mad` function from the plausi package.

```{r ,message=FALSE, warning=FALSE}

diff1_grouped <- split(diff1, diff1$combination)

diff2_grouped <- lapply(diff1_grouped, function(combs) {
  # Calculate outlier column (with a threshold of 5 median deviations from median instead of 3.5)
  combs$outlier <- is_outlier_double_mad(combs$difference, threshold = 5)
  
  # Calculate median difference for the group
  combs$median_difference <- median(combs$difference, na.rm = TRUE)
  
  combs
})

# Combine processed groups back into a single data frame
diff2 <- do.call(rbind, diff2_grouped)

```

A plot helps to visualize the distribution of differences and to identify particularly  values.

```{r}

ggplot(diff2, aes(combination, difference)) +
  geom_violin() +
  geom_jitter(alpha = 0.3, aes(color = outlier)) +
  theme_minimal() +
  scale_color_viridis_d()

```

In some combinations, there are differences of up to 3 percentage points in certain cases.

```{r}

head(diff2[order(abs(diff2$difference), decreasing = TRUE), ])

```

## Finding Municipalities with the Most Notable Turnout Differences

To pinpoint municipalities with the most suspicious turnout differences that may require further investigation, we count the number of flagged outlier combinations for each municipality.

By ranking municipalities based on the number of these anomalous combinations, we can efficiently prioritise our review efforts. Municipalities with the highest count of flagged cases are considered the most critical for further scrutiny.

```{r , message=FALSE, warning=FALSE}

# Split the combinations
diff2$vote1 <- unlist(strsplit(diff2$combination, "_"))[1]
diff2$vote2 <- unlist(strsplit(diff2$combination, "_"))[2]

# Filter rows where 'outlier' is TRUE
filtered_data <- diff2[diff2$outlier == TRUE, ]

# Reshape the data from wide to long format for 'vorlage1' and 'vorlage2'
long_data <- reshape(
  filtered_data,
  varying = list(c("vote1", "vote2")),
  v.names = "vorlage_id",
  times = c("vote1", "vote2"),
  timevar = "vorlage_id",
  direction = "long"
) |> 
  subset(
  select = -c(
    id, 
    combination, 
    difference, 
    median_difference
  )
)

# Count occurrences of each combination of 'mun_name', 'mun_id', and 'vorlage_id'
counts <- aggregate(
  . ~ mun_name + mun_id + vorlage_id,
  data = long_data,
  FUN = length
)

# Finalise
anomalous_results <- counts[order(-counts$outlier), ]
names(anomalous_results)[names(anomalous_results) == "outlier"] <- "n"

anomalous_results

```

In the context of electoral analysis, the ballot on the __Jagdgesetz__ associated with vorlage_id 6320 raises some questions in the case of the municipality of Buch am Irchel. To illustrate this further, we can examine the absolute turnout numbers provided in the column eingelegteStimmzettel.

For four out of the five voting topics, the number of incoming ballots was either 484 or 486. However, for one specific topic, the count is noticeably lower, by a margin of 20 ballots. While this discrepancy does not necessarily imply an error, it is a situation that warrants further attention.

## Why This Difference Matters

Such deviations are noteworthy and typically prompt follow-up discussions with the municipalities involved. Possible explanations include:

- Misplaced Ballots: There may have been a mishap leading to the misplacement of 20 ballots.

- Aggregation Error: There may have been a mishap leading to an erroneous aggregation of the different bundles of ballots.

- Data Entry Error: The discrepancy could also result from a typographical mistake during the data entry process into the election result system.

While there is no immediate evidence of wrongdoing or a systemic issue, these kinds of irregularities are part of our standard review process to ensure the accuracy and integrity of the electoral data.

```{r}

data[data$mun_name == "Buch am Irchel", ] |> 
  subset(select = c(
    mun_name, 
    mun_id, 
    name, 
    id, 
    eingelegteStimmzettel
  ))

```
