---
title: "prediction"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{prediction}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(plausi)
library(tidyverse)
library(swissdd)


pred_res <- results %>% 
  filter(canton_id==1& mun_id!=9010) %>% 
  select(mun_id,id, jaStimmenInProzent)

predzh <-pred_res %>% tidyr::spread(id,jaStimmenInProzent)

colnames(predzh) <- paste("v", colnames(predzh), sep = "_")

ausgez_gem <- cantdata_820 %>% 
  filter(canton_name=="ZH"&id==104955&gebietAusgezaehlt==TRUE) %>%
  pull(mun_id)

train <- predzh %>% mutate(v_5850=ifelse(v_mun_id %in% ausgez_gem,NA, v_5850)) %>% 
  rename(v_gemwkid=v_mun_id) %>% 
  mutate(gemeinde="")

hello <- predict_votes("v_5850",train)

votedata1 <- votedata %>% mutate_at(vars(Eidg1,Kant1),~ifelse(v_gemwkid %in% ausgez_gem,NA, .x))

hello2 <- predict_votes(c("Eidg1","Kant1"),train=votedata1,exclude_votes = TRUE)

glimpse(votedata)


```


# Solve Overfitting
https://blog.zenggyu.com/en/post/2018-06-16/multivariate-adaptive-regression-splines-in-a-nutshell/

```{r}
sundata_369 <- readRDS("C:/gitrepos/abstimmungen_PlausiTool/app/testdata/sundata_369.RDS")

features <- readRDS("C:/gitrepos/plausi/data/20200927/features2020-09-27.RDS")

# wide to long
pred_act <- sundata_369 %>% 
  select(gemeinde,gemwkid, artsort, jastimmeninprozent) %>% 
  tidyr::spread(artsort,jastimmeninprozent)

# Hier code einbauen der nur Vorlagen mit mehr als 5-10 eintr채gen aufweist

pred_all <- pred_act %>% 
  filter(gemwkid != 9010)%>% 
  rename(v_gemwkid = gemwkid)%>% 
  # allenfalls auf right-join umstellen
  right_join(features, by = c("v_gemwkid")) %>% 
  #hack um gemeindelabels f체r Gemeinden die noch nicht auf gelb sind beizubehalten
  mutate(gemeinde=v_gemeinde) %>% 
  select(-v_gemeinde)

ControlParamteres <- caret::trainControl(method = "cv",
                                  number = 5,
                                  savePredictions = TRUE,
                                  classProbs = TRUE)


parameterGrid <- expand.grid(mtry=c(2,3,4))




pred_all <- pred_all %>% mutate(Eidg3=ifelse(gemeinde=="R체ti", 66, Eidg3))


# Methode von gvcEarth auf pls angepasst
preddata <- predict_votes(votes = colnames(pred_act)[c(-1,-2)], 
                          train = pred_all, 
                          # method = "gcvEarth",
                           method = "earth",
                           metric = "RMSE",
                          minspan = 5,
                          # trainControl = ControlParamteres,
                          # tuneGrid=expand.grid(degree=1:3,seq(2, 100, length.out = 10)),
                          exclude_votes = TRUE) %>% 
                  mutate(differenz = abs(real - pred)) %>% 
                  mutate_if(is.numeric,~round(.,1)) %>% 
                  rename(Gemeinde=gemeinde)

preddata %>% filter(Gemeinde=="R체ti")






```

